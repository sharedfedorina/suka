#!/bin/bash

# Pre-commit hook –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ –ø—Ä–æ–µ–∫—Ç—É –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ª–µ–Ω–¥—ñ–Ω–≥—ñ–≤
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞: —Å–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ–π —Ñ–∞–π–ª –≤ .git/hooks/pre-commit —ñ –∑—Ä–æ–±—ñ—Ç—å executable

echo "üîí –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω –ø–µ—Ä–µ–¥ commit..."

# –ö—Ä–∏—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏ —è–∫—ñ –Ω–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª—è—Ç–∏
CRITICAL_FILES=(
  "user-config.json"
  "package.json"
  ".env"
  "server.js"
  "netlify.toml"
)

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
deleted_files=$(git diff --cached --name-only --diff-filter=D)

for critical_file in "${CRITICAL_FILES[@]}"; do
  if echo "$deleted_files" | grep -q "^$critical_file$"; then
    echo ""
    echo "üö® –ü–û–ú–ò–õ–ö–ê: –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –≤–∏–¥–∞–ª—è—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω–∏–π —Ñ–∞–π–ª: $critical_file"
    echo ""
    echo "–Ø–∫—â–æ —Ü–µ –ø–æ–º–∏–ª–∫–∞ Claude Code - –≤—ñ–¥–º—ñ–Ω–∏ –∑–º—ñ–Ω–∏:"
    echo "  git reset HEAD $critical_file"
    echo "  git checkout -- $critical_file"
    echo ""
    exit 1
  fi
done

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–∞–ø–æ–∫
CRITICAL_DIRS=(
  "sections"
  "modules"
  "server/replacements"
  "lib"
)

for critical_dir in "${CRITICAL_DIRS[@]}"; do
  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –Ω–µ –≤–∏–¥–∞–ª–µ–Ω—ñ –≤—Å—ñ —Ñ–∞–π–ª–∏ –∑ –∫—Ä–∏—Ç–∏—á–Ω–æ—ó –ø–∞–ø–∫–∏
  if [ -d "$critical_dir" ]; then
    files_in_dir=$(find "$critical_dir" -type f | wc -l)
    if [ "$files_in_dir" -eq 0 ]; then
      echo ""
      echo "üö® –ü–û–ú–ò–õ–ö–ê: –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–∞–ø–∫–∞ –ø–æ—Ä–æ–∂–Ω—è: $critical_dir/"
      echo ""
      echo "–í—ñ–¥–Ω–æ–≤—ñ—Ç—å —Ñ–∞–π–ª–∏ –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ commit:"
      echo "  git checkout HEAD -- $critical_dir/"
      echo ""
      exit 1
    fi
  fi
done

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏ (> 5MB)
large_files=$(git diff --cached --name-only | while read file; do
  if [ -f "$file" ]; then
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
    if [ "$size" -gt 5242880 ]; then
      echo "$file ($(($size / 1024 / 1024))MB)"
    fi
  fi
done)

if [ ! -z "$large_files" ]; then
  echo ""
  echo "‚ö†Ô∏è  –ü–û–ü–ï–†–ï–î–ñ–ï–ù–ù–Ø: –í–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏ –≤ commit:"
  echo "$large_files"
  echo ""
  echo "–†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ."
  echo ""
  read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ commit? (y/n) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ user-config.json –Ω–∞ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å JSON
if echo "$deleted_files" | grep -v -q "^user-config.json$"; then
  if git diff --cached --name-only | grep -q "^user-config.json$"; then
    echo "üìù –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ user-config.json..."
    if ! git show :user-config.json | python3 -m json.tool > /dev/null 2>&1; then
      echo ""
      echo "üö® –ü–û–ú–ò–õ–ö–ê: user-config.json –º—ñ—Å—Ç–∏—Ç—å –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π JSON!"
      echo ""
      echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å JSON –ø–µ—Ä–µ–¥ commit."
      echo ""
      exit 1
    fi
    echo "‚úÖ user-config.json –≤–∞–ª—ñ–¥–Ω–∏–π"
  fi
fi

# –í—Å–µ –û–ö
echo "‚úÖ –í—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω–æ"
echo ""

exit 0
